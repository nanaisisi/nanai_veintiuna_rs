# 次期更新 (一時まとめ)

目的: 次期リリースで実装したい機能を短くまとめ、優先度と実装メモを残す。後で個別の issue / PR に分割する。

## 要件（ユーザーからの要望）

- プレイヤー操作を「選択肢を選ぶ形式」にする（メニュー式）
- プレイヤーが「定石選択肢」を選べるようにする（複数戦略プリセット）
- 賭け金の変更をメニューで可能にする
- ゲーム終了（Quit）選択肢を用意する
- セーブはオートセーブで良い（手動セーブ不要）

## ゲームデザイン要件

- 勝てるゲーム: 定石に従ってプレイした場合の勝率が50%を超えるようにゲームバランスを調整する
- プレイヤー有利設定: `player_edge` や早期サレンダーなどの要素を組み合わせ、基本戦略の実行で長期的にプレイヤーが勝ち越せる環境を提供する

## 受け入れ基準（アウトカム）

- 起動後にメインメニューが表示され、選択肢で操作できること
- 定石プリセットを選ぶと、その戦略に従ってプレイが進むこと
- 賭け金は増減でき、次ラウンドに反映されること
- 終了選択で安全にゲームを終え、現在状態はオートセーブされること

## データ設計（提案）

- MenuChoice enum: {StartGame, SelectStrategy, ChangeBet, LoadSave, Quit}
- Strategy enum: {Basic, Conservative, Aggressive, Custom}
- PlayerState: {bank: i64, current_bet: i64, strategy: Strategy}
- Save format: TOML (既存設定と合わせる)、自動保存は PlayerState を `save/player_state.toml` に書く
- バックアップ世代管理: 過去のセーブを広い間隔（例: 10ラウンド毎、1日毎）で `save/backup/` に保存し、履歴を残す

## UI / フロー案（簡潔）

1. メインメニュー表示: Start / Strategy / Bet / Quit
2. Strategy ではプリセット一覧を表示し、選択で即時反映
3. Bet では +/- か金額入力で現在ベットを変更（規定範囲チェック）
4. Start でゲームループへ。ラウンド終了時に自動でセーブ。
5. Quit は確認プロンプトの後セーブして終了

## 実装メモとファイル変更提案

- `game.rs`: メニュー表示と入力パーサを追加。既存の `run_game` をラウンド単位の呼び出しに分離。
- `config.rs`/`game_config.toml`: Strategy とオートセーブ設定（true/false、保存先）を追加。
- `main.rs`: 起動時に状態ロード→メニュー表示→適切ハンドラへ遷移。
- セーブ処理は失敗をリトライし、失敗時はログを残す（秘密情報不要）。
- バックアップ管理: 定期的（ラウンド数やプレイ時間基準）に `save/backup/player_state_YYYY-MM-DD_HH-MM.toml` 形式で履歴保存。古いバックアップは自動削除（例: 30日経過後）。

### ゲーム性変更

- サレンダー: Early Surrender（早期サレンダー）の実装。基本戦略に従い、16 vs 9/10/A、15 vs 10 でサレンダー可能にする。

## エッジケースと検討点

- セーブ中にクラッシュした場合の部分書き込み対策（tmpファイルへ書いてから rename）
- 賭け金の下限/上限（負数禁止、銀行残高以上を禁止）
- バックアップファイル管理: ディスク容量制限、古いファイルの自動削除ポリシー、バックアップ失敗時の処理
- マルチスレッドや並列性は当面不要。UI は同期的な CLI 前提。

## テスト案

- メニュー遷移のユニットテスト（選択肢→期待する状態遷移）
- セーブ/ロードの round-trip テスト
- Strategy が変更されたときの挙動スナップショットテスト
- バックアップ世代管理テスト: 指定間隔でのバックアップ作成、古いファイルの自動削除、バックアップからの復元

## 優先度（提案）

1. メニュー式操作（必須）
2. 定石プリセットの選択（必須）
3. 賭け金の変更（必須）
4. サレンダー（Early Surrender 前提）（必須）
5. オートセーブ（重要）
6. Quit 確認と安全な終了（重要）

---
## 次期アップデート実行時手順

### 変更点の一時保存

次期アップデートを実行する際は、以下の手順で変更点を記録する:

1. 実装前に変更予定項目を `docs/update_changes.md` に一時保存
2. 各機能実装時に実際の変更内容を同ファイルに追記
3. アップデート完了後、一般ファイル（README.md、concept.md等）を新バージョンに合わせて全体最適化
4. 変更点は重視せず、全体として自然で一貫した内容になるよう静かに更新
5. `docs/update_changes.md` は実装完了後に削除または archive へ移動

### 一般ファイル更新方針

- 個別の変更点を強調するのではなく、全体として最適化された内容に調整
- 新機能は自然に統合され、元からあった機能として記述
- ドキュメントの一貫性と読みやすさを最優先とする

メモ: これを元に小さな PR に分割できます。望むなら最初の PR（メニュー表示 + simple strategy 選択）を作成してコード変更を進めます。どれを優先しますか？
